---
title: 重复测量数据方差分析
author: Fang Yongchao
date: "2021-03-11"
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>
<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/jquery/jquery.min.js"></script>
<link href="/rmarkdown-libs/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/datatables-binding/datatables.js"></script>
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="/rmarkdown-libs/dt-core/js/jquery.dataTables.min.js"></script>
<link href="/rmarkdown-libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/crosstalk/js/crosstalk.min.js"></script>


<p>相关包：<a href="https://mirrors.tuna.tsinghua.edu.cn/CRAN/web/packages/car/index.html">car</a></p>
<p>在这里仅记录重复测量数据方差分析的R语言实现及结果解释，不涉及其原理说明。</p>
<p>重复测量数据的方差分析的步骤大致如下图：</p>
<div class="figure"><span id="fig:unnamed-chunk-1"></span>
<img src="/posts/20210311_repeat_measure_anova_files/figure-html/unnamed-chunk-1-1.png" alt="重复测量数据方差分析流程图" width="672" />
<p class="caption">
Figure 1: 重复测量数据方差分析流程图
</p>
</div>
<div id="数据" class="section level1">
<h1>数据</h1>
<p>使用下面的代码造一份假数据，50个对象，分成5个处理分组（甲乙丙丁戊），对每个对象进行4次重复测量。</p>
<pre class="r"><code>set.seed(2414)
dat &lt;- data.frame(
  ID = gl(50, 1),
  group = gl(5, 10, labels = c(&quot;甲&quot;, &quot;乙&quot;, &quot;丙&quot;, &quot;丁&quot;, &quot;戊&quot;)),
  measure_1 = round(rnorm(50, 50), 2),
  measure_2 = round(rnorm(50, 30), 2),
  measure_3 = round(rnorm(50, 20), 2),
  measure_4 = round(rnorm(50, 40), 2)
)
DT::datatable(dat)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50"],["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50"],["甲","甲","甲","甲","甲","甲","甲","甲","甲","甲","乙","乙","乙","乙","乙","乙","乙","乙","乙","乙","丙","丙","丙","丙","丙","丙","丙","丙","丙","丙","丁","丁","丁","丁","丁","丁","丁","丁","丁","丁","戊","戊","戊","戊","戊","戊","戊","戊","戊","戊"],[51.1,49.96,49.9,50.29,50.82,49.22,51,49.87,49.56,49.3,50.47,48.57,48.11,49.7,50.04,50.17,49.66,49.49,49.23,52.01,50.29,50.43,48.29,50.57,50.68,48.49,48.44,48.81,50.84,47.95,50.09,50.35,50.43,48.89,48.87,49.68,51,50.27,48.47,50.11,48,50.96,49.39,50.7,48.82,50.2,48.89,48.59,50.15,51.89],[29.29,28.75,29.8,28.95,30.46,29.41,29.5,30.43,30,30.65,29.08,30.02,30.42,32.44,29.36,29.68,30.32,29.36,30.38,29.78,30.13,28.51,31.96,29.97,30.39,29.99,29.03,30.27,29.85,31.31,31.04,30.23,30.74,29.75,30.84,28.49,29.83,29.43,29.48,29.9,29.51,29.29,29.45,28.59,30.66,29.79,30.41,30.16,30.73,28.79],[19.5,18.87,19.05,20.32,21.2,19.33,19.87,21.47,20.57,18.46,19.45,19.31,20.22,19.77,21.37,19,18.13,19.29,21.87,20.4,20.12,17.62,19.2,19.6,18.98,20.13,19.23,19.11,21.12,20.09,20.66,18.12,21.74,20.78,20.54,17.98,17.76,21.36,20.09,22.41,19.19,18.94,19.91,21.81,20.11,19.52,19.5,21.51,19.87,20.86],[39.58,38.73,40.06,39.26,40.39,39.9,40.06,38.64,40.84,37.97,40.9,41.04,42.12,39.13,39.73,39.86,39.03,38.1,39.1,39.99,41.21,40.31,39.5,40.91,41.45,40.83,40.88,39.38,40.05,39.48,41.13,41.01,39.64,40.28,39.11,40.55,40.3,40.65,41.4,41.11,39.77,37.12,39.72,40.45,41,40.66,39.63,43.26,41.39,38.64]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>ID<\/th>\n      <th>group<\/th>\n      <th>measure_1<\/th>\n      <th>measure_2<\/th>\n      <th>measure_3<\/th>\n      <th>measure_4<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="正态性检验" class="section level1">
<h1>正态性检验</h1>
<p>由于存在5个处理分组，每个分组进行了4次重复测量，故共有20组数据需要做正态性检验。考虑将数据转换成长数据方便使用<code>lapply</code>函数一次性完成所有分组的正态性检验。</p>
<pre class="r"><code>data.table::setDT(dat)
long_dat &lt;- data.table::melt(
  dat, id.vars = c(&quot;ID&quot;, &quot;group&quot;), measure.vars = paste0(&quot;measure_&quot;, 1:4),
  variable.name = &quot;time&quot;, value.name = &quot;response&quot; 
)
DT::datatable(long_dat)</code></pre>
<div id="htmlwidget-2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200"],["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50"],["甲","甲","甲","甲","甲","甲","甲","甲","甲","甲","乙","乙","乙","乙","乙","乙","乙","乙","乙","乙","丙","丙","丙","丙","丙","丙","丙","丙","丙","丙","丁","丁","丁","丁","丁","丁","丁","丁","丁","丁","戊","戊","戊","戊","戊","戊","戊","戊","戊","戊","甲","甲","甲","甲","甲","甲","甲","甲","甲","甲","乙","乙","乙","乙","乙","乙","乙","乙","乙","乙","丙","丙","丙","丙","丙","丙","丙","丙","丙","丙","丁","丁","丁","丁","丁","丁","丁","丁","丁","丁","戊","戊","戊","戊","戊","戊","戊","戊","戊","戊","甲","甲","甲","甲","甲","甲","甲","甲","甲","甲","乙","乙","乙","乙","乙","乙","乙","乙","乙","乙","丙","丙","丙","丙","丙","丙","丙","丙","丙","丙","丁","丁","丁","丁","丁","丁","丁","丁","丁","丁","戊","戊","戊","戊","戊","戊","戊","戊","戊","戊","甲","甲","甲","甲","甲","甲","甲","甲","甲","甲","乙","乙","乙","乙","乙","乙","乙","乙","乙","乙","丙","丙","丙","丙","丙","丙","丙","丙","丙","丙","丁","丁","丁","丁","丁","丁","丁","丁","丁","丁","戊","戊","戊","戊","戊","戊","戊","戊","戊","戊"],["measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_1","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_2","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_3","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4","measure_4"],[51.1,49.96,49.9,50.29,50.82,49.22,51,49.87,49.56,49.3,50.47,48.57,48.11,49.7,50.04,50.17,49.66,49.49,49.23,52.01,50.29,50.43,48.29,50.57,50.68,48.49,48.44,48.81,50.84,47.95,50.09,50.35,50.43,48.89,48.87,49.68,51,50.27,48.47,50.11,48,50.96,49.39,50.7,48.82,50.2,48.89,48.59,50.15,51.89,29.29,28.75,29.8,28.95,30.46,29.41,29.5,30.43,30,30.65,29.08,30.02,30.42,32.44,29.36,29.68,30.32,29.36,30.38,29.78,30.13,28.51,31.96,29.97,30.39,29.99,29.03,30.27,29.85,31.31,31.04,30.23,30.74,29.75,30.84,28.49,29.83,29.43,29.48,29.9,29.51,29.29,29.45,28.59,30.66,29.79,30.41,30.16,30.73,28.79,19.5,18.87,19.05,20.32,21.2,19.33,19.87,21.47,20.57,18.46,19.45,19.31,20.22,19.77,21.37,19,18.13,19.29,21.87,20.4,20.12,17.62,19.2,19.6,18.98,20.13,19.23,19.11,21.12,20.09,20.66,18.12,21.74,20.78,20.54,17.98,17.76,21.36,20.09,22.41,19.19,18.94,19.91,21.81,20.11,19.52,19.5,21.51,19.87,20.86,39.58,38.73,40.06,39.26,40.39,39.9,40.06,38.64,40.84,37.97,40.9,41.04,42.12,39.13,39.73,39.86,39.03,38.1,39.1,39.99,41.21,40.31,39.5,40.91,41.45,40.83,40.88,39.38,40.05,39.48,41.13,41.01,39.64,40.28,39.11,40.55,40.3,40.65,41.4,41.11,39.77,37.12,39.72,40.45,41,40.66,39.63,43.26,41.39,38.64]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>ID<\/th>\n      <th>group<\/th>\n      <th>time<\/th>\n      <th>response<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":4},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p>使用Shapiro-Wilk检验进行正态性检验。该检验零假设为样本来自于正态分布总体，故p值小于0.05时考虑拒绝原假设，即样本来自于非正态总体。</p>
<pre class="r"><code>to_test &lt;- split(long_dat$response, list(long_dat$group, long_dat$time))
norm_result &lt;- lapply(to_test, function(v) data.frame(
  p_value = shapiro.test(v)$p.value
))
norm_result &lt;- data.table::rbindlist(norm_result, idcol = &quot;compare_group&quot;)
norm_result</code></pre>
<pre><code>##        compare_group    p_value
##  1: \u7532.measure_1 0.35833010
##  2: \u4e59.measure_1 0.68648547
##  3: \u4e19.measure_1 0.03480044
##  4: \u4e01.measure_1 0.34813734
##  5: \u620a.measure_1 0.85786700
##  6: \u7532.measure_2 0.66370941
##  7: \u4e59.measure_2 0.02642396
##  8: \u4e19.measure_2 0.65775054
##  9: \u4e01.measure_2 0.69533045
## 10: \u620a.measure_2 0.64659753
## 11: \u7532.measure_3 0.77310856
## 12: \u4e59.measure_3 0.77343765
## 13: \u4e19.measure_3 0.59508292
## 14: \u4e01.measure_3 0.21361576
## 15: \u620a.measure_3 0.29621704
## 16: \u7532.measure_4 0.85644876
## 17: \u4e59.measure_4 0.78965802
## 18: \u4e19.measure_4 0.24633955
## 19: \u4e01.measure_4 0.44817852
## 20: \u620a.measure_4 0.90706871</code></pre>
</div>
<div id="方差齐性检验" class="section level1">
<h1>方差齐性检验</h1>
<p>使用Levene检验进行方差齐性检验。该检验零假设为样本所在总体方差相等，故p值小于0.05时考虑拒绝原假设，即样本所在总体方差不等。</p>
<pre class="r"><code>homo_result &lt;- car::leveneTest(response ~ group*time, data = long_dat)
homo_result</code></pre>
<pre><code>## Levene&#39;s Test for Homogeneity of Variance (center = median)
##        Df F value Pr(&gt;F)
## group  19  1.1521 0.3039
##       180</code></pre>
</div>
<div id="方差分析" class="section level1">
<h1>方差分析</h1>
<p>若数据满足正态性与方差齐性，则可以进行方差分析（本文中使用的数据其实并没有通过正态性检验，但由于只是为了进行方法的说明，就当作它通过了吧）。</p>
<p>重复测量数据的方差分析关键在于区分组内因子和组间因子，对于这里的数据来说，多次的重复测量为组内因子，而处理分组（甲乙丙丁戊）为组间因子。网上很多文章中将处理分组也当作组内因子看待，如<a href="http://rstudio-pubs-static.s3.amazonaws.com/153245_0efc926bbb10484c841b44220205d910.html#two-way-repeated-measures-anova">双因素重复测量方差分析</a>，和这里的区别在于作为唯一标识的ID一列。在本文中，数据收集于50个不同的对象，每个处理分组中的对象都是不同的，而在<a href="http://rstudio-pubs-static.s3.amazonaws.com/153245_0efc926bbb10484c841b44220205d910.html#two-way-repeated-measures-anova">双因素重复测量方差分析</a>中，不同处理组是对相同的对象进行操作（虽然在文字描述中是将42名不同的对象分成两组，但是<code>id &lt;- factor(rep(1:21, times=2*3))</code>这一行代码将这42个对象当作了21个对象来看待）。</p>
<p>base R中的<code>anova</code>函数可以直接进行重复测量数据方差分析，代码如下：</p>
<pre class="r"><code>aov &lt;- aov(response ~ group*time + Error(ID/time), data = long_dat)
summary(aov)</code></pre>
<pre><code>## 
## Error: ID
##           Df Sum Sq Mean Sq F value Pr(&gt;F)
## group      4   2.05  0.5125   0.479  0.751
## Residuals 45  48.13  1.0695               
## 
## Error: ID:time
##             Df Sum Sq Mean Sq  F value Pr(&gt;F)    
## time         3  24900    8300 7766.990 &lt;2e-16 ***
## group:time  12     10       1    0.792  0.658    
## Residuals  135    144       1                    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>结果中的上部Error: ID部分展示了处理分组间差异的自由度、离均差平方和、F值、p值等结果，其中的Residuals部分为组间误差。下部Error: ID:time部分展示了重复测量以及处理分组和重复测量的交互作用的相关结果，其中的Residuals部分为组内误差。</p>
</div>
<div id="球形检验" class="section level1">
<h1>球形检验</h1>
<p>简单来说，球形检验是为了检验重复测量的不同时间测量值的差值的方差是否相等，其零假设为差值的方差相等。当球形检验的p值大于0.05时，我们可以直接使用上面方差分析的结果，但是当球形检验的p值小于0.05时，则需要对方差分析的自由度和p值进行校正。</p>
<p>通过以下代码进行Mauchly球形检验：</p>
<pre class="r"><code>fit &lt;- lm(cbind(measure_1, measure_2, measure_3, measure_4) ~ group + 1, data = dat)
idata &lt;- data.frame(time = gl(4, 1))
sph_result &lt;- mauchly.test(fit, X = ~ 1, M = ~ time, idata = idata)
sph_result</code></pre>
<pre><code>## 
##  Mauchly&#39;s test of sphericity
##  Contrasts orthogonal to
##  ~1
## 
##  Contrasts spanned by
##  ~time
## 
## 
## data:  SSD matrix from lm(formula = cbind(measure_1, measure_2, measure_3, measure_4) ~  SSD matrix from     group + 1, data = dat)
## W = 0.95802, p-value = 0.8662</code></pre>
</div>
<div id="p值校正" class="section level1">
<h1>p值校正</h1>
<p>在base R中没有找到对p值进行校正的相关方法实现。而在<a href="https://mirrors.tuna.tsinghua.edu.cn/CRAN/web/packages/car/index.html">car</a>包中有对方差分析、球形检验、p值校正一整套打包实现的方法。</p>
<pre class="r"><code>fit &lt;- lm(cbind(measure_1, measure_2, measure_3, measure_4) ~ group + 1, data = dat)
idata &lt;- data.frame(time = gl(4, 1))
aov_result &lt;- car::Anova(fit, idata = idata, idesign = ~ time)
summary(aov_result, multivariate = FALSE, univariate = TRUE)</code></pre>
<pre><code>## Warning in summary.Anova.mlm(aov_result, multivariate = FALSE, univariate =
## TRUE): HF eps &gt; 1 treated as 1</code></pre>
<pre><code>## 
## Univariate Type II Repeated-Measures ANOVA Assuming Sphericity
## 
##             Sum Sq num Df Error SS den Df    F value Pr(&gt;F)    
## (Intercept) 244033      1   48.126     45 2.2818e+05 &lt;2e-16 ***
## group            2      4   48.126     45 4.7920e-01 0.7508    
## time         24900      3  144.265    135 7.7670e+03 &lt;2e-16 ***
## group:time      10     12  144.265    135 7.9170e-01 0.6583    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## 
## Mauchly Tests for Sphericity
## 
##            Test statistic p-value
## time              0.95802  0.8662
## group:time        0.95802  0.8662
## 
## 
## Greenhouse-Geisser and Huynh-Feldt Corrections
##  for Departure from Sphericity
## 
##             GG eps Pr(&gt;F[GG])    
## time       0.97256     &lt;2e-16 ***
## group:time 0.97256      0.655    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
##              HF eps    Pr(&gt;F[HF])
## time       1.047255 6.290759e-151
## group:time 1.047255  6.583041e-01</code></pre>
<p>结果与上方使用base R进行方差分析和球形检验的结果基本一致，在最后多出了用Greenhouse-Geisser和Huynh-Feldt方法进行校正后的p值。</p>
</div>
<div id="多重比较" class="section level1">
<h1>多重比较</h1>
</div>
