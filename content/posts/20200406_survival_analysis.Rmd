---
title: 生存分析及R语言实现
author: Fang Yongchao
date: "2021-04-06"
output:
  blogdown::html_page:
    toc: yes
    toc_depth: 2
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
knitr::opts_chunk$set(fig.align = "center", fig.width = 6, fig.asp = 0.7)
library(survival)
library(survminer)
```

相关包：[survival](https://mirrors.tuna.tsinghua.edu.cn/CRAN/web/packages/survival/index.html)，[survminer](https://mirrors.tuna.tsinghua.edu.cn/CRAN/web/packages/survminer/index.html)

使用数据：`data(cancer, package="survival")`

## 相关概念

生存分析主要用于分析感兴趣的事件发生所需要的时间以及变量对事件发生的影响。

有如下几个相关概念：

- 事件（Event）：比如在癌症相关研究中，病人的死亡
- 时间（Time）：当事件没有发生时，时间就是起始时间到当前时间的跨度，当事件发生时，时间为起始时间到事件发生的时间跨度
- 删失（Censoring）：个人认为这个概念没必要过度理解，截止到某时间点事件没有发生（这个时间点可能是当前时间，也可能是失去调查对象数据的中间某个时间点），即为删失
- 生存函数（Survival Function）：一般写作$S(t)$，表示从起始时间到时间t没有发生事件的概率
- 危险函数（Harzard Function）：一般写作$h(t)$或$\lambda(t)$，表示在截止到时间t事件都没有发生的条件下，事件接下来发生的瞬时概率

## Kaplan-Meier方法

Kaplan-Meier方法是一种非参数估计生存概率的方法，计算公式为：

$$
S(t) = \prod_{i; t_i \le t} \left( 1 - {d_i \over n_i} \right)
$$
这里对于每一个$i$，在时间$t_i$都发生了至少一次事件，$d_i$为在时间$t_i$发生的事件数，$n_i$为在时间$t_i$还未发生事件的个体数。

使用函数`survfit()`进行估计：
```{r}
fit <- survfit(Surv(time, status) ~ sex, data = kidney)
str(fit)
```

绘制生存曲线。`ggsurvplot()`拥有众多参数对生存曲线的图进行修改完善。
```{r}
ggsurvplot(fit)
```

## Log-rank检验

Log-rank检验对两个或两个以上的生存曲线进行比较，其零假设为生存曲线之间没有差异。

使用函数`survdiff()`进行检验：
```{r}
out <- survdiff(Surv(time, status) ~ sex, data = kidney)
out
```

这个检验结果也可以在绘制生存曲线时将**pval**参数设为TRUE得到。

## Cox比例风险回归





